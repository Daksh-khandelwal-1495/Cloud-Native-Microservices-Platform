name: CI/CD - Build and Push Images

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAMESPACE: ${{ github.repository_owner }}

jobs:
  build-and-push:
    name: Build and push Docker images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }} # Personal access token with packages:write (or DOCKERHUB_PASSWORD)

      - name: Build and push images (matrix)
        uses: docker/build-push-action@v4
        with:
          push: true
          # Build a matrix of services (each service folder contains a Dockerfile)
          # Tags: sha (immutable) and "latest" only when pushing from main
          # We use build contexts and tags via 'load' false and push true
          platforms: linux/amd64,linux/arm64
          file: ${{ matrix.service }}/Dockerfile
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ matrix.repo_name }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ matrix.repo_name }}:latest
          context: ${{ matrix.service }}
        strategy:
          matrix:
            include:
              - service: catalog-service
                repo_name: catalog-service
              - service: order-service
                repo_name: order-service
              - service: user-service
                repo_name: user-service
              - service: advanced-ml-service
                repo_name: advanced-ml-service

  notify:
    name: Deployment notice
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Notify
        run: |
          echo "Images built and pushed. Replace image tags in k8s manifests or let ArgoCD detect updated manifest if using automated image updater."
